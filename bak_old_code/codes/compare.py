'''
ASD = {
    "CIFAR10":{
        "ResNet18":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/BadNets/2025-02-04_13:08:56/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/BadNets/2025-05-05_13:37:35/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/BadNets/2025-05-08_11:08:28/ckpt/latest_model.pt"
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/IAD/2025-02-17_17:27:09/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/IAD/2025-05-05_13:43:27/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/IAD/2025-05-08_11:12:00/ckpt/latest_model.pt"
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/Refool/2025-02-17_17:49:37/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/Refool/2025-05-05_13:49:42/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/Refool/2025-05-08_11:15:45/ckpt/latest_model.pt"
            },
            "WaNet":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/WaNet/2025-02-17_18:19:07/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/WaNet/2025-05-05_14:01:45/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/ResNet18/WaNet/2025-05-08_11:19:18/ckpt/latest_model.pt"
            }
        },
        "VGG19":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/BadNets/2025-02-17_18:25:45/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/BadNets/2025-05-05_14:13:59/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/BadNets/2025-05-08_11:21:19/ckpt/latest_model.pt"
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/IAD/2025-02-17_18:29:21/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/IAD/2025-05-05_14:49:59/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/IAD/2025-05-08_11:25:45/ckpt/latest_model.pt"
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/Refool/2025-02-27_11:52:39/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/Refool/2025-05-05_15:09:45/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/Refool/2025-05-08_11:33:49/ckpt/latest_model.pt"
            },
            "WaNet":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/WaNet/2025-02-17_18:34:34/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/WaNet/2025-05-05_15:25:23/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/VGG19/WaNet/2025-05-08_11:37:40/ckpt/latest_model.pt"
            }
        },
        "DenseNet":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/BadNets/2025-02-17_18:39:21/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/BadNets/2025-05-05_15:31:35/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/BadNets/2025-05-08_11:51:05/ckpt/latest_model.pt"
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/IAD/2025-02-17_18:41:23/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/IAD/2025-05-05_15:38:38/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/IAD/2025-05-08_11:59:16/ckpt/latest_model.pt"
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/Refool/2025-02-17_18:47:05/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/Refool/2025-05-05_17:11:44/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/Refool/2025-05-08_12:09:07/ckpt/latest_model.pt"
            },
            "WaNet":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/WaNet/2025-02-17_18:59:49/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/WaNet/2025-05-05_17:24:40/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/CIFAR10/DenseNet/WaNet/2025-05-08_12:13:51/ckpt/latest_model.pt"
            }
        }
    },
    "GTSRB":{
        "ResNet18":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/BadNets/2025-02-17_18:54:05/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/BadNets/2025-05-05_17:51:08/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/BadNets/2025-05-08_12:24:30/ckpt/latest_model.pt"
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/IAD/2025-02-17_18:57:13/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/IAD/2025-05-05_18:09:26/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/IAD/2025-05-08_12:32:52/ckpt/latest_model.pt"
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/Refool/2025-02-17_19:40:32/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/Refool/2025-05-05_18:39:23/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/Refool/2025-05-08_13:13:05/ckpt/latest_model.pt"
            },
            "WaNet":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/WaNet/2025-02-17_20:01:40/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/WaNet/2025-05-05_18:43:50/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/ResNet18/WaNet/2025-05-08_13:41:18/ckpt/latest_model.pt"
            }
        },
        "VGG19":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/BadNets/2025-02-17_20:02:49/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/BadNets/2025-05-05_19:05:00/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/BadNets/2025-05-08_13:57:59/ckpt/latest_model.pt"
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/IAD/2025-02-17_20:05:46/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/IAD/2025-05-05_19:08:03/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/IAD/2025-05-08_14:01:46/ckpt/latest_model.pt"
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/Refool/2025-02-17_20:28:34/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/Refool/2025-05-05_19:17:12/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/Refool/2025-05-08_14:48:50/ckpt/latest_model.pt"
            },
            "WaNet":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/WaNet/2025-02-17_20:31:08/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/WaNet/2025-05-05_20:33:23/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/VGG19/WaNet/2025-05-08_15:06:54/ckpt/latest_model.pt"
            }
        },
        "DenseNet":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/BadNets/2025-02-17_20:32:50/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/BadNets/2025-05-05_20:52:45/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/BadNets/2025-05-08_15:14:50/ckpt/latest_model.pt"
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/IAD/2025-02-17_20:35:23/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/IAD/2025-05-05_21:09:36/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/IAD/2025-05-08_19:57:31/ckpt/latest_model.pt"
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/Refool/2025-02-17_20:40:02/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/Refool/2025-05-05_21:47:49/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/Refool/2025-05-08_16:02:04/ckpt/latest_model.pt"
            },
            "WaNet":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/WaNet/2025-02-17_20:44:25/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/WaNet/2025-05-06_12:35:00/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/GTSRB/DenseNet/WaNet/2025-05-08_16:02:49/ckpt/latest_model.pt"
            }
        }
    },
    "ImageNet2012_subset":{
        "ResNet18":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/ResNet18/BadNets/2025-03-07_13:55:26/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/ResNet18/BadNets/2025-05-06_12:47:16/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/BadNets/2025-05-15_21:04:21/ckpt/latest_model.pt"
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/ResNet18/IAD/2025-03-07_20:28:50/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/ResNet18/IAD/2025-05-11_13:38:49/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/ResNet18/IAD/2025-05-09_11:37:01/ckpt/latest_model.pt"
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/ResNet18/Refool/2025-03-07_21:03:57/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/ResNet18/Refool/2025-05-06_13:56:16/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/ResNet18/Refool/2025-05-09_13:22:40/ckpt/latest_model.pt"
            },
            "WaNet":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/ResNet18/WaNet/2025-03-07_21:31:50/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/ResNet18/WaNet/2025-05-06_14:48:29/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/ResNet18/WaNet/2025-05-09_13:48:43/ckpt/latest_model.pt"
            }
        },
        "DenseNet":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/BadNets/2025-03-12_11:30:35/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/BadNets/2025-05-15_20:58:25/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/BadNets/2025-05-09_15:19:19/ckpt/latest_model.pt"
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/IAD/2025-03-12_11:40:01/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/IAD/2025-05-16_11:30:01/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/IAD/2025-05-17_15:39:22/ckpt/latest_model.pt"
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/Refool/2025-03-14_11:10:26/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/Refool/2025-05-13_18:37:06/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/Refool/2025-05-13_18:40:35/ckpt/latest_model.pt"
            },
            "WaNet":{
                "exp_1":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/WaNet/2025-03-14_12:34:37/ckpt/latest_model.pt",
                "exp_2":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/WaNet/2025-05-17_21:50:00/ckpt/latest_model.pt",
                "exp_3":"/data/mml/backdoor_detect/experiments/ASD/ImageNet2012_subset/DenseNet/WaNet/2025-05-16_11:32:37/ckpt/latest_model.pt"
            }
        }
    }
}

Our = {
    "CIFAR10":{
        "ResNet18":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/ResNet18/BadNets/2025-04-30_22:12:52/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/ResNet18/IAD/2025-04-30_22:19:26/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/ResNet18/Refool/2025-04-30_22:26:50/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "WaNet":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/ResNet18/WaNet/2025-04-30_22:33:15/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            }
        },
        "VGG19":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/VGG19/BadNets/2025-04-30_22:40:50/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/VGG19/IAD/2025-04-30_22:53:48/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/VGG19/Refool/2025-04-30_22:55:03/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "WaNet":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/VGG19/WaNet/2025-04-30_22:58:41/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            }
        },
        "DenseNet":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/DenseNet/BadNets/2025-04-30_23:11:52/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/DenseNet/IAD/2025-04-30_23:13:52/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/DenseNet/Refool/2025-04-30_23:15:54/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "WaNet":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/CIFAR10/DenseNet/WaNet/2025-04-30_23:17:33/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            }
        }
    },
    "GTSRB":{
        "ResNet18":{
            "BadNets":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/GTSRB/ResNet18/BadNets/2025-05-02_20:11:49/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "IAD":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/GTSRB/ResNet18/IAD/2025-05-02_20:14:10/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "Refool":{
                "exp_1":"/data/mml/backdoor_detect/experiments/OurMethod/Retrain/GTSRB/ResNet18/Refool/2025-05-02_20:20:12/best_ft_model.pth",
                "exp_2":"",
                "exp_3":""
            },
            "WaNet":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            }
        },
        "VGG19":{
            "BadNets":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "IAD":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "Refool":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "WaNet":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            }
        },
        "DenseNet":{
            "BadNets":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "IAD":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "Refool":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "WaNet":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            }
        }
    },
    "ImageNet2012_subset":{
        "ResNet18":{
            "BadNets":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "IAD":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "Refool":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "WaNet":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            }
        },
        "DenseNet":{
            "BadNets":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "IAD":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "Refool":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            },
            "WaNet":{
                "exp_1":"",
                "exp_2":"",
                "exp_3":""
            }
        }
    }
}
'''
import os
import torch
from torch.utils.data import DataLoader,Subset,ConcatDataset
from codes import config
from codes.common.eval_model import EvalModel

# cifar10
from codes.poisoned_dataset.cifar10.BadNets.generator import gen_poisoned_dataset as cifar10_badNets_gen_poisoned_dataset
from codes.poisoned_dataset.cifar10.IAD.generator import gen_poisoned_dataset as cifar10_IAD_gen_poisoned_dataset
from codes.poisoned_dataset.cifar10.Refool.generator import gen_poisoned_dataset as cifar10_Refool_gen_poisoned_dataset
from codes.poisoned_dataset.cifar10.WaNet.generator import gen_poisoned_dataset as cifar10_WaNet_gen_poisoned_dataset
# gtsrb
from codes.poisoned_dataset.gtsrb.BadNets.generator import gen_poisoned_dataset as gtsrb_badNets_gen_poisoned_dataset
from codes.poisoned_dataset.gtsrb.IAD.generator import gen_poisoned_dataset as gtsrb_IAD_gen_poisoned_dataset
from codes.poisoned_dataset.gtsrb.Refool.generator import gen_poisoned_dataset as gtsrb_Refool_gen_poisoned_dataset
from codes.poisoned_dataset.gtsrb.WaNet.generator import gen_poisoned_dataset as gtsrb_WaNet_gen_poisoned_dataset

# imagenet
from codes.poisoned_dataset.imagenet_sub.BadNets.generator import gen_poisoned_dataset as imagenet_badNets_gen_poisoned_dataset
from codes.poisoned_dataset.imagenet_sub.IAD.generator import gen_poisoned_dataset as imagenet_IAD_gen_poisoned_dataset
from codes.poisoned_dataset.imagenet_sub.Refool.generator import gen_poisoned_dataset as imagenet_Refool_gen_poisoned_dataset
from codes.poisoned_dataset.imagenet_sub.WaNet.generator import gen_poisoned_dataset as imagenet_WaNet_gen_poisoned_dataset

# transform数据集
from codes.transform_dataset import cifar10_BadNets, cifar10_IAD, cifar10_Refool, cifar10_WaNet
from codes.transform_dataset import gtsrb_BadNets, gtsrb_IAD, gtsrb_Refool, gtsrb_WaNet
from codes.transform_dataset import imagenet_BadNets, imagenet_IAD, imagenet_Refool, imagenet_WaNet



def get_fresh_dataset(poisoned_ids,dataset_name,attack_name):
    if dataset_name == "CIFAR10":
        if attack_name == "BadNets":
            poisoned_trainset = cifar10_badNets_gen_poisoned_dataset(poisoned_ids,"train")
            clean_trainset, clean_testset = cifar10_BadNets()

        elif attack_name == "IAD":
            poisoned_trainset = cifar10_IAD_gen_poisoned_dataset(model_name, poisoned_ids,"train")
            clean_trainset, _, clean_testset, _ = cifar10_IAD()
        elif attack_name == "Refool":
            poisoned_trainset = cifar10_Refool_gen_poisoned_dataset(poisoned_ids,"train")
            clean_trainset, clean_testset = cifar10_Refool()
        elif attack_name == "WaNet":
            poisoned_trainset = cifar10_WaNet_gen_poisoned_dataset(model_name,poisoned_ids,"train")
            clean_trainset, clean_testset = cifar10_WaNet()
    elif dataset_name == "GTSRB":
        if attack_name == "BadNets":
            poisoned_trainset = gtsrb_badNets_gen_poisoned_dataset(poisoned_ids,"train")
            clean_trainset, clean_testset = gtsrb_BadNets()
        elif attack_name == "IAD":
            poisoned_trainset = gtsrb_IAD_gen_poisoned_dataset(model_name,poisoned_ids,"train")
            clean_trainset, _, clean_testset, _ = gtsrb_IAD()
        elif attack_name == "Refool":
            poisoned_trainset = gtsrb_Refool_gen_poisoned_dataset(poisoned_ids,"train")
            clean_trainset, clean_testset = gtsrb_Refool()
        elif attack_name == "WaNet":
            poisoned_trainset = gtsrb_WaNet_gen_poisoned_dataset(model_name, poisoned_ids,"train")
            clean_trainset, clean_testset = gtsrb_WaNet()
    elif dataset_name == "ImageNet2012_subset":
        if attack_name == "BadNets":
            poisoned_trainset = imagenet_badNets_gen_poisoned_dataset(poisoned_ids,"train")
            clean_trainset, clean_testset = imagenet_BadNets()
        elif attack_name == "IAD":
            poisoned_trainset = imagenet_IAD_gen_poisoned_dataset(model_name,poisoned_ids,"train")
            clean_trainset, _, clean_testset, _ = imagenet_IAD()
        elif attack_name == "Refool":
            poisoned_trainset = imagenet_Refool_gen_poisoned_dataset(poisoned_ids,"train")
            clean_trainset, clean_testset = imagenet_Refool()
        elif attack_name == "WaNet":
            poisoned_trainset = imagenet_WaNet_gen_poisoned_dataset(model_name, poisoned_ids,"train")
            clean_trainset, clean_testset = imagenet_WaNet()
    return poisoned_trainset, clean_trainset, clean_testset

def single_scence(dataset_name, model_name, attack_name, defense_model_state_dict_path):
    # 加载后门攻击配套数据
    backdoor_data_path = os.path.join(config.exp_root_dir, 
                                    "ATTACK",
                                    dataset_name,
                                    model_name,
                                    attack_name,
                                    "backdoor_data.pth")
    backdoor_data = torch.load(backdoor_data_path,map_location="cpu")
    # 后门模型
    backdoor_model = backdoor_data["backdoor_model"]
    backdoor_model.load_state_dict(torch.load(defense_model_state_dict_path,map_location="cpu")["model_state_dict"])
    # 训练数据集中中毒样本id
    poisoned_ids = backdoor_data["poisoned_ids"]
    # 预制的poisoned_testset
    poisoned_testset = backdoor_data["poisoned_testset"]
    # 根据poisoned_ids得到非预制菜poisoneds_trainset和新鲜clean_testset
    poisoned_trainset, clean_trainset, clean_testset = get_fresh_dataset(poisoned_ids,dataset_name,attack_name)
    # 从poisoned_testset中剔除原来就是target class的数据
    # 不打乱
    clean_testset_loader = DataLoader(
                clean_testset, # 非预制
                batch_size=64, 
                shuffle=False,
                num_workers=4,
                pin_memory=True)
    clean_testset_label_list = []
    for _, batch in enumerate(clean_testset_loader):
        Y = batch[1]
        clean_testset_label_list.extend(Y.tolist())
    filtered_ids = []
    for sample_id in range(len(clean_testset)):
        sample_label = clean_testset_label_list[sample_id]
        if sample_label != config.target_class_idx:
            filtered_ids.append(sample_id)
    filtered_poisoned_testset = Subset(poisoned_testset,filtered_ids)
    # 获得设备
    device = torch.device(f"cuda:{gpu_id}")
    e = EvalModel(backdoor_model,filtered_poisoned_testset,device)
    asr = e.eval_acc()
    e = EvalModel(backdoor_model,clean_testset,device)
    acc = e.eval_acc()
    print("="*30)
    print("结果")
    print("="*30)
    print(f"dataset_name:{dataset_name}")
    print(f"model_name:{model_name}")
    print(f"attack_name:{attack_name}")
    print(f"random_seed:{random_seed}")
    print(f"ASR:{asr}")
    print(f"ACC:{acc}")


dataset_name = "CIFAR10" # ["CIFAR10","GTSRB", "ImageNet2012_subset"]
model_name = "ResNet18" # ["ResNet18", "VGG19", "DenseNet"]
attack_name = "BadNets" # ["BadNets", "IAD", "Refool", "WaNet"]
random_seed = 2
exp_id = f"exp_{random_seed}" # ["exp_1","exp_2","exp_3"]
gpu_id = 0
_time_dir_name = "2025-06-09_16:04:11"
defense_model_state_dict_path = os.path.join(config.exp_root_dir,"ASD_new",dataset_name,model_name,attack_name,_time_dir_name,"ckpt","latest_model.pt")

single_scence(dataset_name,model_name,attack_name,defense_model_state_dict_path)
print("END")



# for dataset_name in ["ImageNet2012_subset"]:
#     for model_name in ["ResNet18", "VGG19", "DenseNet"]:
#         if dataset_name == "ImageNet2012_subset" and model_name == "VGG19":
#             continue
#         for attack_name in ["BadNets", "IAD", "Refool", "WaNet"]:
#             if dataset_name == "ImageNet2012_subset" and model_name == "DenseNet" and attack_name == "IAD":
#                 continue
#             if dataset_name == "ImageNet2012_subset" and model_name == "DenseNet" and attack_name == "WaNet":
#                 continue
#             single_scence(dataset_name,model_name,attack_name)

